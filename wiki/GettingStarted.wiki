#summary How to set up & run vmaki on your own host

= Introduction =
This document describes in the first part the steps needed to take in order to set up a host running the vmaki management node including Xen Hypervisor support. The second part describes how to set up a so called "Xen Host", which is only being used as a container for Xen DomUs but does not provide any management functionality or host vmaki itself.

= Management Node =

== Prerequisites ==
Install Debian Lenny on a physical host using LVM volumes. Make sure there is enough free space within the volume pool for the creation of guest volumes. For client machines the Firefox browser is highly recommended.

== Getting vmaki ==
Check out vmaki's trunk:
{{{
# svn checkout http://vmaki.googlecode.com/svn/trunk/ vmaki
}}}

== Linux ==
Install required packages via apt & RubyGems:
{{{
# sudo apt-get install make gcc ruby ruby-dev rubygems irb libvirt-bin libvirt-dev libxml-ruby postgresql postgresql-server-dev-8.3 sqlite3 libsqlite3-dev libopenssl-ruby libxml2-dev libxslt-ruby libxslt1-dev ssh-askpass-gnome openssh-server nfs-kernel-server
}}}
Add the following line to the .profile file in your home directory:
{{{
PATH="$PATH:/var/lib/gems/1.8/bin"
}}}
Immediately apply those changes to your environment and upgrade !RubyGems to >1.3.1:
{{{
# source .profile
# sudo gem install rubygems-update
# cd /var/lib/gems/1.8/bin
# sudo ./update_rubygems
}}}
Install some more gems:
{{{
# sudo gem install rails rake mongrel postgres libxml-ruby uuid net-ssh net-sftp
}}}
download http://vmaki.googlecode.com/svn/trunk/ruby-libvirt/pkg/ruby-libvirt-0.1.1.gem
{{{
# sudo gem install ruby-libvirt-0.1.1.gem
}}}

== Xen ==
Edit "/etc/xen/xend-config.sxp" and add the following line:
{{{
(xend-unix-server yes)
(network-script 'network-bridge')
(vnc-listen '0.0.0.0')
}}}

You can optionally also add a VNC Password:
{{{
(vncpasswd 'mypassword')
}}}

Create a symlink called "xen" pointing to the lib folder of the xen installation to be used:
{{{
ln -sf /usr/lib64/xen-3.2-1 /usr/lib64/xen
}}}

== PostgreSQL ==
=== PostgreSQL Settings ===

Change password of the postgres admin user:
{{{
# sudo passwd postgres
}}}
 
Create a new database and connect to it:
{{{
# sudo -u postgres createdb test
# sudo -u postgres psql test
}}}

Then change the password of the database user as well:
{{{
test=# alter user postgres with password 'PASSWORD';
}}}

Then edit the postgresql.conf file:
{{{
# sudo gedit /etc/postgresql/8.3/main/postgresql.conf
}}}

And change the line:
{{{
#listen_addresses = 'localhost'
}}}
*TO:*
{{{
listen_addresses = '*'
}}}
The line:
{{{
#password_encryption = on
}}}
*TO:*
{{{
password_encryption = on
}}}
Now edit the file "/etc/postgresql/8.3/main/pg_hba.conf" and change all lines containing the following:
{{{
# sudo gedit /etc/postgresql/8.3/main/pg_hba.conf
local all all ident sameuser
}}}
*TO:*
{{{
local all all md5
}}}

=== Create new vmaki User ===

{{{
# sudo -u postgres createuser --superuser vmaki
# sudo -u postgres createdb vmaki
# sudo -u postgres psql vmaki
vmaki=# alter user vmaki with password 'virtual_M0nk83!';
\q
}}}

== NFS ==

Install NFS Server & create directory:
{{{
# chmod 777 /var/vmaki/isos
# mkdir -p /mnt/tmp
}}}

Add the following line to "/etc/exports":
{{{
/var/vmaki/isos *(ro,sync,insecure,no_root_squash,no_subtree_check)
}}}

Now export the filesystem and mount it:
{{{
# sudo exportfs -ra
# sudo mount IP:/var/vmaki/isos /mnt/tmp
}}}

== Final Steps ==
Set up the database (change into vmaki's directory):
{{{
# rake db:migrate
}}}

Start the vmaki process (also insides vmaki's directory):
{{{
# script/server
}}}

= Xen Node =

== Install all Packages ==

* Check if NFS client has to be installed *

# sudo apt-get install xen-linux-system-2.6.26-2-xen-amd64 libvirt-bin openssh-server

== Xen ==

== SSH ==